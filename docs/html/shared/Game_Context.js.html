<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><link type="text/css" rel="stylesheet" href="custom.css"><title>Source: Game/Context.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="",baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="dark" data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/shared</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="g2Ybb8D-oAV_SNc64RXCv"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="AudioComponent.html">AudioComponent</a></div><div class="sidebar-section-children"><a href="AudioModel.html">AudioModel</a></div><div class="sidebar-section-children"><a href="ColliderComponent.html">ColliderComponent</a></div><div class="sidebar-section-children"><a href="ColliderController.html">ColliderController</a></div><div class="sidebar-section-children"><a href="ColliderModel.html">ColliderModel</a></div><div class="sidebar-section-children"><a href="Command.html">Command</a></div><div class="sidebar-section-children"><a href="Component.html">Component</a></div><div class="sidebar-section-children"><a href="Context.html">Context</a></div><div class="sidebar-section-children"><a href="Controller.html">Controller</a></div><div class="sidebar-section-children"><a href="Diff.html">Diff</a></div><div class="sidebar-section-children"><a href="ExternalScriptComponent.html">ExternalScriptComponent</a></div><div class="sidebar-section-children"><a href="ExternalScriptModel.html">ExternalScriptModel</a></div><div class="sidebar-section-children"><a href="GameScriptComponent.html">GameScriptComponent</a></div><div class="sidebar-section-children"><a href="GameScriptModel.html">GameScriptModel</a></div><div class="sidebar-section-children"><a href="Interpolator.html">Interpolator</a></div><div class="sidebar-section-children"><a href="Model.html">Model</a></div><div class="sidebar-section-children"><a href="NativeCommandManager.html">NativeCommandManager</a></div><div class="sidebar-section-children"><a href="Object3D.html">Object3D</a></div><div class="sidebar-section-children"><a href="PartialString.html">PartialString</a></div><div class="sidebar-section-children"><a href="ProcessInterval.html">ProcessInterval</a></div><div class="sidebar-section-children"><a href="RenderComponent.html">RenderComponent</a></div><div class="sidebar-section-children"><a href="RenderModel.html">RenderModel</a></div><div class="sidebar-section-children"><a href="ScriptBase.html">ScriptBase</a></div><div class="sidebar-section-children"><a href="ScriptController.html">ScriptController</a></div><div class="sidebar-section-children"><a href="ScriptModel.html">ScriptModel</a></div><div class="sidebar-section-children"><a href="ShapeWrapper.html">ShapeWrapper</a></div><div class="sidebar-section-children"><a href="State.html">State</a></div><div class="sidebar-section-children"><a href="StringComposer.html">StringComposer</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="QGKgC99r3JEiOfmY1jLxf"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Audio.html">Audio</a></div><div class="sidebar-section-children"><a href="module-Collider.html">Collider</a></div><div class="sidebar-section-children"><a href="module-ExternalScript.html">ExternalScript</a></div><div class="sidebar-section-children"><a href="module-GameScript.html">GameScript</a></div><div class="sidebar-section-children"><a href="module-Render.html">Render</a></div><div class="sidebar-section-children"><a href="module-Script.html">Script</a></div><div class="sidebar-section-children"><a href="module-Type.html">Type</a></div><div class="sidebar-section-children"><a href="module-udvizShared.html">udvizShared</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="Z4J_udiTDeh33f5xYD2L5"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Architecture.html">Architecture</a></div><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserD2.html">BrowserD2</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcD2.html">BrowserSrcD2</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcFrame3D.html">BrowserSrcFrame3D</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcGame.html">BrowserSrcGame</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcGameD3.html">BrowserSrcGameD3</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcWidgetD3.html">BrowserSrcWidgetD3</a></div><div class="sidebar-section-children"><a href="tutorial-Node.html">Node</a></div><div class="sidebar-section-children"><a href="tutorial-SharedD3.html">SharedD3</a></div><div class="sidebar-section-children"><a href="tutorial-SharedSrcGame.html">SharedSrcGame</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="daRMmMDYkBf-T1Iuqwlol"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CircleJSON">CircleJSON</a></div><div class="sidebar-section-children"><a href="global.html#ContextListener">ContextListener</a></div><div class="sidebar-section-children"><a href="global.html#DragAndDropAvatarVariables">DragAndDropAvatarVariables</a></div><div class="sidebar-section-children"><a href="global.html#PolygonJSON">PolygonJSON</a></div><div class="sidebar-section-children"><a href="global.html#ProcessIntervalTickRequester">ProcessIntervalTickRequester</a></div><div class="sidebar-section-children"><a href="global.html#TraverseCallback">TraverseCallback</a></div><div class="sidebar-section-children"><a href="global.html#arrayEquals">arrayEquals</a></div><div class="sidebar-section-children"><a href="global.html#arrayPushOnce">arrayPushOnce</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsEuler">checkIfSubStringIsEuler</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsMatrix4">checkIfSubStringIsMatrix4</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsVector3">checkIfSubStringIsVector3</a></div><div class="sidebar-section-children"><a href="global.html#computeFileFormat">computeFileFormat</a></div><div class="sidebar-section-children"><a href="global.html#dataUriToBuffer">dataUriToBuffer</a></div><div class="sidebar-section-children"><a href="global.html#eulerArrayFromURIComponent">eulerArrayFromURIComponent</a></div><div class="sidebar-section-children"><a href="global.html#getAttributeByPath">getAttributeByPath</a></div><div class="sidebar-section-children"><a href="global.html#imageToDataURI">imageToDataURI</a></div><div class="sidebar-section-children"><a href="global.html#int32ArrayToObject">int32ArrayToObject</a></div><div class="sidebar-section-children"><a href="global.html#matrix4ArrayFromURIComponent">matrix4ArrayFromURIComponent</a></div><div class="sidebar-section-children"><a href="global.html#objectEquals">objectEquals</a></div><div class="sidebar-section-children"><a href="global.html#objectOverWrite">objectOverWrite</a></div><div class="sidebar-section-children"><a href="global.html#objectParse">objectParse</a></div><div class="sidebar-section-children"><a href="global.html#objectParseNumeric">objectParseNumeric</a></div><div class="sidebar-section-children"><a href="global.html#objectToInt32Array">objectToInt32Array</a></div><div class="sidebar-section-children"><a href="global.html#removeEmptyValues">removeEmptyValues</a></div><div class="sidebar-section-children"><a href="global.html#removeFromArray">removeFromArray</a></div><div class="sidebar-section-children"><a href="global.html#vector3ArrayFromURIComponent">vector3ArrayFromURIComponent</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"><div class="navbar-item"><a id="Github" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udvizBrowser" href="../browser" target="">udvizBrowser</a></div><div class="navbar-item"><a id="udvizShared" href="../shared" target="">udvizShared</a></div><div class="navbar-item"><a id="udvizNode" href="../node" target="">udvizNode</a></div></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">Game_Context.js</h1></header><article><pre class="prettyprint source lang-js"><code>const { Collisions } = require('detect-collisions');
const Collider = require('./Component/Collider');
const Script = require('./Component/Script');
const GameScript = require('./Component/GameScript');
const Object3D = require('./Object3D');
const State = require('./State/State');
const Command = require('../Command');
const THREE = require('three');

/**
 * @callback ContextListener
 * @param {*} params - params pass when event is dispatched
 */

/** @class */
const Context = class {
  /**
   * Handle collisions, add/remove gameobject3D, process commands + trigger {@link ScriptBase} event
   *
   * @param {Object&lt;string,import("./Context").ScriptBase>} gameScriptClass - map of class extended {@link ScriptBase}
   * @param {Object3D} object3D - root game object3D
   */
  constructor(gameScriptClass, object3D) {
    /**
     *
     * @returns {Object&lt;string,import("./Context").ScriptBase>} - formated gamescript class
     */
    const formatGameScriptClass = () => {
      const result = {};

      const parse = (object) => {
        for (const key in object) {
          const value = object[key];

          if (value.IS_SCRIPTBASE) {
            if (result[value.ID_SCRIPT])
              throw new Error('no unique id ' + value.ID_SCRIPT);
            result[value.ID_SCRIPT] = value;
          } else if (value instanceof Object) {
            parse(value);
          } else {
            console.error(object, value, key, object.name);
            throw new Error(
              'wrong value type ' + typeof object + ' key ' + key
            );
          }
        }
      };

      parse(gameScriptClass);

      return result;
    };

    /**
     * class that can be reference by {@link GameScript} of an object3D
     *
     * @type {Object&lt;string,import("./Context").ScriptBase>}
     */
    this.gameScriptClass = formatGameScriptClass();

    /**
     * root game object3D
     *
     * @type {import("./Object3D").Object3D}
     */
    this.object3D = object3D;

    /**
     * Collisions system {@link https://www.npmjs.com/package/detect-collisions}
     *
     * @type {Collisions}
     */
    this.collisions = new Collisions();

    /**
     * Buffer to handle collision events {@link Context.EVENT}
     *
     * @type {Object&lt;string,string>}
     */
    this.collisionsBuffer = {};

    /**
     * Listeners of custom events
     *
     * @type {Object&lt;string,ContextListener[]>}
     */

    this.listeners = {};

    /**
     * delta time
     *
     * @type {number}
     */
    this.dt = 0;

    /** 
     * commands buffer
     *  
     @type {Array&lt;Command>} */
    this.commands = [];
  }

  /**
   * Create a class instance of game script class for an object3D  given an id
   *
   * @param {string} id - id of the class
   * @param {Object3D} object3D - object3D that is going to use this instance
   * @param {object} modelVariables - custom variables associated to this instance
   * @returns {import("./Context").ScriptBase} - instance of the class bind with object3D and modelVariables
   */
  createInstanceOf(id, object3D, modelVariables) {
    const constructor = this.gameScriptClass[id];
    if (!constructor) {
      console.log('script loaded');
      for (const key in this.gameScriptClass) {
        console.log(this.gameScriptClass[key]);
      }
      throw new Error('no script with id ' + id);
    }
    return new constructor(this, object3D, modelVariables);
  }

  /**
   * Load its object3D
   *
   * @returns {Promise} - promise resolving at the end of the load
   */
  load() {
    return this.loadObject3D(this.object3D);
  }

  /**
   * Load an object3D into context
   *
   * @param {import("./Object3D").Object3D} obj - object3D to load
   * @returns {Promise} - promise resolving at the end of the load
   */
  loadObject3D(obj) {
    return new Promise((resolve) => {
      // init game component controllers of object3D
      this.initComponentControllers(obj);

      // compute promises
      const promises = [];

      obj.traverse(function (child) {
        const scriptC = child.getComponent(GameScript.Component.TYPE);
        if (scriptC) {
          const scripts = scriptC.getController().getScripts();
          for (const idScript in scripts) {
            const result = scriptC
              .getController()
              .executeScript(scripts[idScript], Context.EVENT.LOAD);
            if (result) promises.push(result);
          }
        }
      });

      Promise.all(promises).then(() => {
        this.registerObject3DCollision(obj);

        // trigger Context.EVENT.INIT
        this.dispatchScriptEvent(obj, Context.EVENT.INIT);

        resolve();
      });
    }).catch((error) => {
      console.error(error);
    });
  }

  /**
   * Step context
   *
   * @param {number} dt - new delta time of step
   */
  step(dt) {
    this.dt = dt;

    this.commands.forEach((cmd) => {
      this.dispatchScriptEvent(this.object3D, Context.EVENT.ON_COMMAND, [
        cmd.type,
        cmd.data,
      ]);
    });
    this.commands.length = 0; // clear command

    this.dispatchScriptEvent(this.object3D, Context.EVENT.TICK);

    this.updateCollision(this.object3D);

    this.object3D.traverse((child) => {
      if (child.isStatic()) return;
      const colliderComponent = child.getComponent(Collider.Component.TYPE);
      if (colliderComponent) {
        const collidedObject3D = [];
        const buffer = this.collisionsBuffer[child.uuid];

        colliderComponent
          .getController()
          .getShapeWrappers()
          .forEach((wrapper) => {
            const shape = wrapper.getShape();
            const potentials = shape.potentials();
            const result = this.collisions.createResult();
            for (const p of potentials) {
              /** In {@link ShapeWrapper} shape are link to shapewrapper */
              const potentialObject3D = p.getWrapper().getObject3D();
              if (!potentialObject3D.isStatic()) continue;
              if (shape.collides(p, result)) {
                collidedObject3D.push(potentialObject3D.uuid);

                // child collides with potentialObject3D
                if (buffer.includes(potentialObject3D.uuid)) {
                  // Already collided
                  this.dispatchScriptEvent(
                    child,
                    Context.EVENT.IS_COLLIDING,
                    [potentialObject3D],
                    false
                  );
                  this.dispatchScriptEvent(
                    potentialObject3D,
                    Context.EVENT.IS_COLLIDING,
                    [child],
                    false
                  );
                } else {
                  // OnEnter
                  buffer.push(potentialObject3D.uuid); // Register in buffer

                  // notify both gameobject
                  this.dispatchScriptEvent(
                    child,
                    Context.EVENT.ON_ENTER_COLLISION,
                    [potentialObject3D],
                    false
                  );
                  this.dispatchScriptEvent(
                    potentialObject3D,
                    Context.EVENT.ON_ENTER_COLLISION,
                    [child],
                    false
                  );
                }

                // move position of the no static object3D according the collide result
                if (
                  colliderComponent.getModel().isBody() &amp;&amp;
                  p.getWrapper().isBody()
                ) {
                  child.position.sub(
                    new THREE.Vector3(
                      result.overlap * result.overlap_x,
                      result.overlap * result.overlap_y,
                      0
                    )
                  );
                  child.setOutdated(true);
                  // child position has changed updated collider
                  this.updateCollision(child);
                }
              }
            }
          });

        // Notify onLeave
        for (let i = buffer.length - 1; i >= 0; i--) {
          const uuid = buffer[i];
          if (!collidedObject3D.includes(uuid)) {
            const gameObjectCollided = this.object3D.getObjectByProperty(
              'uuid',
              uuid
            );

            this.dispatchScriptEvent(
              child,
              Context.EVENT.ON_LEAVE_COLLISION,
              [gameObjectCollided],
              false
            );
            this.dispatchScriptEvent(
              gameObjectCollided,
              Context.EVENT.ON_LEAVE_COLLISION,
              [child],
              false
            );
            buffer.splice(i, 1); // Remove from buffer
          }
        }
      }
    });
  }

  /**
   * It will dispatch an event to all {@link ScriptBase} in object3D
   *
   * @param {import("./Object3D").Object3D} object3D - object3D that you want to dispatch the event to.
   * @param {string} event - name of the event to dispatch see possible value in {@link Context.EVENT}
   * @param {any[]} params - params to pass to {@link ScriptBase}
   * @param {boolean} [recursive=true] - traverse object3D child if true
   */
  dispatchScriptEvent(object3D, event, params = [], recursive = true) {
    if (recursive) {
      object3D.traverse(function (child) {
        const scriptComponent = child.getComponent(GameScript.Component.TYPE);
        if (scriptComponent) {
          scriptComponent.getController().execute(event, params);
        }
      });
    } else {
      const scriptComponent = object3D.getComponent(GameScript.Component.TYPE);
      if (scriptComponent) {
        scriptComponent.getController().execute(event, params);
      }
    }
  }

  /**
   * Initialize controllers used in context
   *
   * @param {Object3D} obj - object3D to initialize controllers
   */
  initComponentControllers(obj) {
    obj.traverse((child) => {
      const components = child.getComponents();
      for (const type in components) {
        const component = child.getComponent(type);
        if (component.getController())
          throw new Error('controller already init ' + child.name);
        const scripts = {};
        switch (type) {
          case GameScript.Component.TYPE:
            component
              .getModel()
              .getIdScripts()
              .forEach((idScript) => {
                scripts[idScript] = this.createInstanceOf(
                  idScript,
                  child,
                  component.getModel().getVariables()
                );
              });
            component.initController(
              new Script.Controller(component.getModel(), child, scripts)
            );
            break;
          case Collider.Component.TYPE:
            component.initController(
              new Collider.Controller(component.getModel(), child)
            );
            break;
          default:
          // no need to initialize controller for this component
        }
      }
    });
  }

  /**
   * Add a object3D into the collision system
   *
   * @param {import("./Object3D").Object3D} object3D - object3D to register
   */
  registerObject3DCollision(object3D) {
    object3D.traverse((child) => {
      if (this.collisionsBuffer[child.uuid]) return; // Already add
      this.collisionsBuffer[child.uuid] = [];

      const colliderComponent = child.getComponent(Collider.Component.TYPE);
      if (colliderComponent) {
        colliderComponent
          /** @type {Context} */ .getController()
          .getShapeWrappers()
          .forEach((wrapper) => {
            this.collisions.insert(wrapper.getShape());
          });
      }
    });

    this.updateCollisionBuffer();
  }

  /**
   * Update object3D collider controller + update collisions system
   *
   * @param {Object3D} object3D - object3D to update
   */
  updateCollision(object3D) {
    object3D.traverse((child) => {
      const colliderComponent = child.getComponent(Collider.Component.TYPE);
      if (colliderComponent) colliderComponent.getController().update();
    });
    this.collisions.update();
  }

  /**
   * Update the collision buffer
   */
  updateCollisionBuffer() {
    this.updateCollision(this.object3D);

    for (const uuid in this.collisionsBuffer) {
      this.collisionsBuffer[uuid].length = 0; // reset buffer
    }

    this.object3D.traverse((child) => {
      if (child.isStatic()) return;
      const colliderComponent = child.getComponent(Collider.Component.TYPE);
      if (colliderComponent) {
        colliderComponent
          .getController()
          .getShapeWrappers()
          .forEach((wrapper) => {
            const shape = wrapper.getShape();
            const potentials = shape.potentials();
            const result = this.collisions.createResult();
            for (const p of potentials) {
              /** In {@link ShapeWrapper} shape are link to gameObject*/
              const potentialObject3D = p.getWrapper().getObject3D();
              if (!potentialObject3D.isStatic()) continue;
              if (shape.collides(p, result)) {
                if (
                  !this.collisionsBuffer[child.uuid].includes(
                    potentialObject3D.uuid
                  )
                )
                  this.collisionsBuffer[child.uuid].push(
                    potentialObject3D.uuid
                  );
              }
            }
          });
      }
    });

    // this.logCollisionBuffer('update collision buffer');
  }

  logCollisionBuffer(tag) {
    console.log('**************************** LOG_COLLISION_BUFFER' + tag);
    for (const id in this.collisionsBuffer) {
      const bufferArray = this.collisionsBuffer[id];
      if (bufferArray.length) {
        console.log(
          this.object3D.getObjectByProperty('uuid', id).name,
          'collide with'
        );
        bufferArray.forEach((idc) => {
          console.log(this.object3D.getObjectByProperty('uuid', idc).name);
        });
      }
    }
    console.log('****************************');
  }

  /**
   * Remove a GameObject from the collision system
   *
   * @param {Object3D} object3D - object3D to remove
   */
  unregisterObject3DCollision(object3D) {
    object3D.traverse((child) => {
      const comp = child.getComponent(Collider.Component.TYPE);
      if (comp) {
        comp
          .getController()
          .getShapeWrappers()
          .forEach((wrapper) => {
            wrapper.getShape().remove();
          });

        // Delete from buffer
        delete this.collisionsBuffer[child.uuid];
        for (const id in this.collisionsBuffer) {
          const index = this.collisionsBuffer[id].indexOf(object3D.uuid);
          if (index >= 0) this.collisionsBuffer[id].splice(index, 1); // Remove from the other
        }
      }
    });
  }

  /**
   * Add an object3D in context. If a parentUUID is specifed it will be add to its, root otherwise
   *
   * @param {Object3D} obj - object3D to add
   * @param {string=} parentUUID - uuid of parent object3D
   * @returns {Promise} - promise resolving when add
   */
  addObject3D(obj, parentUUID = null) {
    if (parentUUID) {
      const parent = this.object3D.getObjectByProperty('uuid', parentUUID);
      parent.add(obj);
    } else {
      this.object3D.add(obj);
    }

    return this.loadObject3D(obj);
  }

  /**
   * Remove a object3D of context
   *
   * @param {string} uuid - uuid of the object3D to remove
   */
  removeObject3D(uuid) {
    const object3D = this.object3D.getObjectByProperty('uuid', uuid);
    if (object3D) {
      object3D.removeFromParent();
      this.unregisterObject3DCollision(object3D);
    } else {
      console.warn('no object with uuid = ', uuid);
    }
  }

  /**
   * Register a custom event
   *
   * @param {string} eventID - Id of the event
   * @param {Function} cb - Callback to be called when the event is dispatched
   */
  on(eventID, cb) {
    if (!this.listeners[eventID]) this.listeners[eventID] = [];
    this.listeners[eventID].push(cb);
  }

  /**
   * Dispatch custom event to listeners
   *
   * @param {string} eventID - Id of the event to dispatch
   * @param {Array} args - Params to passed to listeners
   */
  dispatch(eventID, args) {
    if (!this.listeners[eventID]) {
      console.warn('no listener on event ', eventID);
    } else {
      this.listeners[eventID].forEach(function (cb) {
        cb(args);
      });
    }
  }

  /**
   * Pass new commands to apply at the next step
   *
   * @param {Command[]} cmds - new commands to apply at the next step
   */
  onCommands(cmds) {
    this.commands.push(...cmds);
  }

  /**
   * Convert context root object3D to {@link State} and reset outdated attributes of all object3D
   *
   * @param {boolean} full - model of object3D with controllers should be export
   * @returns {State} - current state of context
   */
  toState(full = true) {
    const result = new State(
      new Object3D(this.object3D.toJSON(full)),
      Date.now()
    );

    // Everything is not outdated yet
    this.object3D.traverse(function (child) {
      child.setOutdated(false);
    });

    return result;
  }

  /**
   *
   * @param {string} id - id of script
   * @param {Object3D} [object3D=this.object3D] - object3D to traverse to find the game script (default is the root game object3D)
   * @returns {ScriptBase|null} - first game script with id or null if none are found
   */
  findGameScriptWithID(id, object3D = this.object3D) {
    let result = null;

    object3D.traverse(function (child) {
      if (!child.isGameObject3D) return;

      const gameScriptComp = child.getComponent(GameScript.Component.TYPE);

      if (!gameScriptComp) return;

      const scripts = gameScriptComp.getController().getScripts();
      if (scripts &amp;&amp; scripts[id]) {
        result = scripts[id];
        return true;
      }
      return false;
    });

    return result;
  }
};

/**
 * Events triggered by context to {@link ScriptBase}
 *
 * @type {Object&lt;string,string>}
 */
Context.EVENT = {
  LOAD: 'load',
  INIT: 'init',
  TICK: 'tick',
  ON_ENTER_COLLISION: 'onEnterCollision',
  IS_COLLIDING: 'isColliding',
  ON_LEAVE_COLLISION: 'onLeaveCollision',
  ON_COMMAND: 'onCommand',
};

/**
 * @class
 */
const ScriptBase = class {
  /**
   * Skeleton of a game context script, different {@link Context.EVENT} are trigger by {@link Context}
   *
   * @param {Context} context - context of this script
   * @param {Object3D} object3D - object3D bind (attach) to this script
   * @param {object} variables - custom variables bind (attach) to this script
   */
  constructor(context, object3D, variables) {
    /**
     * context of this script
     *
     * @type {Context}
     */
    this.context = context;
    /**
     * object3D attach to this script
     *
     * @type {Object3D}
     */
    this.object3D = object3D;
    /**
     * custom variables attach to this script
     *
     * @type {object}
     */
    this.variables = variables;
  }
  /**
   * call after object3D controllers initialized
   *
   * @returns {Promise=} - promise when object3D has loaded
   */
  load() {
    // return null by default
    return null;
  }
  /**
   * call after object3D load and register in collision system
   */
  init() {}
  /**
   * call every step
   */
  tick() {}
  /**
   * call if object3D is not static and first collide a static object3D (object3D must have {@link Collider})
   *
   * @param {Object3D} object3D - object3D collided
   */
  // eslint-disable-next-line no-unused-vars
  onEnterCollision(object3D) {}
  /**
   * call if object3D is not static and is colliding a static object3D (object3D must have {@link Collider})
   *
   * @param {Object3D} object3D - object3D collided
   */
  // eslint-disable-next-line no-unused-vars
  isColliding(object3D) {}
  /**
   * call if object3D is not static and was colliding a static object3D (object3D must have {@link Collider})
   *
   * @param {Object3D} object3D - object3D collided leaving
   */
  // eslint-disable-next-line no-unused-vars
  onLeaveCollision(object3D) {}
  /**
   * call when {@link Context} receive new command
   *
   * @param {string} type - type of the command
   * @param {object} data - data of the command
   */
  // eslint-disable-next-line no-unused-vars
  onCommand(type, data) {}

  static get ID_SCRIPT() {
    console.error(this.name);
    throw new Error('this is abstract class you should override ID_SCRIPT');
  }

  static get IS_SCRIPTBASE() {
    return true;
  }
};

module.exports = {
  Context: Context,
  ScriptBase: ScriptBase,
};
</code></pre></article></section><footer class="footer" id="PeOAagUepe"><div class="wrapper">Fork: <a href="https://github.com/VCityTeam/UD-Viz">https://github.com/VCityTeam/UD-Viz</a></div></footer></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">@ud-viz/shared</a><div class="mobile-nav-links"><div class="navbar-item"><a id="Github-mobile" href="https://github.com/VCityTeam/UD-Viz" target="_blank">Github</a></div><div class="navbar-item"><a id="Examples-mobile" href="https://ud-viz.vcityliris.data.alpha.grandlyon.com/" target="_blank">Examples</a></div><div class="navbar-item"><a id="udvizHome-mobile" href="../" target="">udviz</a></div><div class="navbar-item"><a id="udvizBrowser-mobile" href="../browser" target="">udvizBrowser</a></div><div class="navbar-item"><a id="udvizShared-mobile" href="../shared" target="">udvizShared</a></div><div class="navbar-item"><a id="udvizNode-mobile" href="../node" target="">udvizNode</a></div></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="g2Ybb8D-oAV_SNc64RXCv"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="AudioComponent.html">AudioComponent</a></div><div class="sidebar-section-children"><a href="AudioModel.html">AudioModel</a></div><div class="sidebar-section-children"><a href="ColliderComponent.html">ColliderComponent</a></div><div class="sidebar-section-children"><a href="ColliderController.html">ColliderController</a></div><div class="sidebar-section-children"><a href="ColliderModel.html">ColliderModel</a></div><div class="sidebar-section-children"><a href="Command.html">Command</a></div><div class="sidebar-section-children"><a href="Component.html">Component</a></div><div class="sidebar-section-children"><a href="Context.html">Context</a></div><div class="sidebar-section-children"><a href="Controller.html">Controller</a></div><div class="sidebar-section-children"><a href="Diff.html">Diff</a></div><div class="sidebar-section-children"><a href="ExternalScriptComponent.html">ExternalScriptComponent</a></div><div class="sidebar-section-children"><a href="ExternalScriptModel.html">ExternalScriptModel</a></div><div class="sidebar-section-children"><a href="GameScriptComponent.html">GameScriptComponent</a></div><div class="sidebar-section-children"><a href="GameScriptModel.html">GameScriptModel</a></div><div class="sidebar-section-children"><a href="Interpolator.html">Interpolator</a></div><div class="sidebar-section-children"><a href="Model.html">Model</a></div><div class="sidebar-section-children"><a href="NativeCommandManager.html">NativeCommandManager</a></div><div class="sidebar-section-children"><a href="Object3D.html">Object3D</a></div><div class="sidebar-section-children"><a href="PartialString.html">PartialString</a></div><div class="sidebar-section-children"><a href="ProcessInterval.html">ProcessInterval</a></div><div class="sidebar-section-children"><a href="RenderComponent.html">RenderComponent</a></div><div class="sidebar-section-children"><a href="RenderModel.html">RenderModel</a></div><div class="sidebar-section-children"><a href="ScriptBase.html">ScriptBase</a></div><div class="sidebar-section-children"><a href="ScriptController.html">ScriptController</a></div><div class="sidebar-section-children"><a href="ScriptModel.html">ScriptModel</a></div><div class="sidebar-section-children"><a href="ShapeWrapper.html">ShapeWrapper</a></div><div class="sidebar-section-children"><a href="State.html">State</a></div><div class="sidebar-section-children"><a href="StringComposer.html">StringComposer</a></div><div class="sidebar-section-children"><a href="module.exports_module.exports.html">exports</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="QGKgC99r3JEiOfmY1jLxf"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-Audio.html">Audio</a></div><div class="sidebar-section-children"><a href="module-Collider.html">Collider</a></div><div class="sidebar-section-children"><a href="module-ExternalScript.html">ExternalScript</a></div><div class="sidebar-section-children"><a href="module-GameScript.html">GameScript</a></div><div class="sidebar-section-children"><a href="module-Render.html">Render</a></div><div class="sidebar-section-children"><a href="module-Script.html">Script</a></div><div class="sidebar-section-children"><a href="module-Type.html">Type</a></div><div class="sidebar-section-children"><a href="module-udvizShared.html">udvizShared</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="Z4J_udiTDeh33f5xYD2L5"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-Architecture.html">Architecture</a></div><div class="sidebar-section-children"><a href="tutorial-Changelog.html">Changelog</a></div><div class="sidebar-section-children"><a href="tutorial-Contributors.html">Contributors</a></div><div class="sidebar-section-children"><a href="tutorial-Developers.html">Developers</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserD2.html">BrowserD2</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcD2.html">BrowserSrcD2</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcFrame3D.html">BrowserSrcFrame3D</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcGame.html">BrowserSrcGame</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcGameD3.html">BrowserSrcGameD3</a></div><div class="sidebar-section-children"><a href="tutorial-BrowserSrcWidgetD3.html">BrowserSrcWidgetD3</a></div><div class="sidebar-section-children"><a href="tutorial-Node.html">Node</a></div><div class="sidebar-section-children"><a href="tutorial-SharedD3.html">SharedD3</a></div><div class="sidebar-section-children"><a href="tutorial-SharedSrcGame.html">SharedSrcGame</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="daRMmMDYkBf-T1Iuqwlol"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#CircleJSON">CircleJSON</a></div><div class="sidebar-section-children"><a href="global.html#ContextListener">ContextListener</a></div><div class="sidebar-section-children"><a href="global.html#DragAndDropAvatarVariables">DragAndDropAvatarVariables</a></div><div class="sidebar-section-children"><a href="global.html#PolygonJSON">PolygonJSON</a></div><div class="sidebar-section-children"><a href="global.html#ProcessIntervalTickRequester">ProcessIntervalTickRequester</a></div><div class="sidebar-section-children"><a href="global.html#TraverseCallback">TraverseCallback</a></div><div class="sidebar-section-children"><a href="global.html#arrayEquals">arrayEquals</a></div><div class="sidebar-section-children"><a href="global.html#arrayPushOnce">arrayPushOnce</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsEuler">checkIfSubStringIsEuler</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsMatrix4">checkIfSubStringIsMatrix4</a></div><div class="sidebar-section-children"><a href="global.html#checkIfSubStringIsVector3">checkIfSubStringIsVector3</a></div><div class="sidebar-section-children"><a href="global.html#computeFileFormat">computeFileFormat</a></div><div class="sidebar-section-children"><a href="global.html#dataUriToBuffer">dataUriToBuffer</a></div><div class="sidebar-section-children"><a href="global.html#eulerArrayFromURIComponent">eulerArrayFromURIComponent</a></div><div class="sidebar-section-children"><a href="global.html#getAttributeByPath">getAttributeByPath</a></div><div class="sidebar-section-children"><a href="global.html#imageToDataURI">imageToDataURI</a></div><div class="sidebar-section-children"><a href="global.html#int32ArrayToObject">int32ArrayToObject</a></div><div class="sidebar-section-children"><a href="global.html#matrix4ArrayFromURIComponent">matrix4ArrayFromURIComponent</a></div><div class="sidebar-section-children"><a href="global.html#objectEquals">objectEquals</a></div><div class="sidebar-section-children"><a href="global.html#objectOverWrite">objectOverWrite</a></div><div class="sidebar-section-children"><a href="global.html#objectParse">objectParse</a></div><div class="sidebar-section-children"><a href="global.html#objectParseNumeric">objectParseNumeric</a></div><div class="sidebar-section-children"><a href="global.html#objectToInt32Array">objectToInt32Array</a></div><div class="sidebar-section-children"><a href="global.html#removeEmptyValues">removeEmptyValues</a></div><div class="sidebar-section-children"><a href="global.html#removeFromArray">removeFromArray</a></div><div class="sidebar-section-children"><a href="global.html#vector3ArrayFromURIComponent">vector3ArrayFromURIComponent</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>