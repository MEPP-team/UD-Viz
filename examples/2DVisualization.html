<!DOCTYPE html>
<html>
  <head>
    <title>2D Visualization example</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/css/examples.css" />
  </head>
  <body>
    <script src="../packages/browser/dist/RUN_MODE/bundle.js"></script>

    <script type="text/javascript">
      udvizBrowser
        .loadMultipleJSON([
          './assets/config/extents.json',
          './assets/config/crs.json',
          './assets/config/frame3D_planars.json',
          './assets/config/layer/base_maps.json',
          './assets/config/layer/elevation.json',
          './assets/config/layer/3DTiles.json',
        ])
        .then((configs) => {
          udvizBrowser.proj4.default.defs(
            configs['crs'][0].name,
            configs['crs'][0].transform
          );

          const extent = new udvizBrowser.itowns.Extent(
            configs['extents'][0].name,
            parseInt(configs['extents'][0].west),
            parseInt(configs['extents'][0].east),
            parseInt(configs['extents'][0].south),
            parseInt(configs['extents'][0].north)
          );

          const frame3DPlanar = new udvizBrowser.Frame3DPlanar(
            extent,
            configs['frame3D_planars'][2]
          );

          // ADD BASE MAP
          udvizBrowser.addBaseMapLayer(
            configs['base_maps'][0],
            frame3DPlanar.itownsView,
            extent
          );

          // ADD ELEVATION LAYER
          udvizBrowser.addElevationLayer(
            configs['elevation'],
            frame3DPlanar.itownsView,
            extent
          );

          // ADD LAYERS
          udvizBrowser.add3DTilesLayers(
            configs['3DTiles'],
            frame3DPlanar.itownsView
          );

          const button = document.createElement('button');
          button.innerHTML = 'Change visualization mode to 3D';
          button.style.zIndex = 2;
          button.style.position = 'relative';
          button.style.cursor = 'pointer';
          frame3DPlanar.domElementUI.appendChild(button);

          const planarLayer = frame3DPlanar.itownsView.tileLayer;
          const elevationLayer = frame3DPlanar.itownsView
            .getLayers()
            .filter((el) => el.isElevationLayer)[0];

          elevationLayer.scale = 0;

          const update3DTilesHeight = (tileContent) => {
            if (
              !isNaN(tileContent.tileId) &&
              tileContent.tileId >= 0 &&
              tileContent.layer.tilesC3DTileFeatures.has(tileContent.tileId)
            ) {
              tileContent.traverse((el) => {
                if (el.geometry && el.geometry.attributes._BATCHID) {
                  for (const [
                    // eslint-disable-next-line no-unused-vars
                    batchId,
                    c3DTFeature,
                  ] of tileContent.layer.tilesC3DTileFeatures.get(
                    tileContent.tileId
                  )) {
                    const worldBox3 =
                      tileContent.layer.computeWorldBox3(c3DTFeature);
                    let featureElevation = worldBox3.min.z;

                    const c3DTFeaturePos = new udvizBrowser.THREE.Vector3()
                      .addVectors(worldBox3.max, worldBox3.min)
                      .divideScalar(2);
                    c3DTFeaturePos.z = worldBox3.min.z;
                    if (elevationLayer.scale == 1) {
                      featureElevation =
                        udvizBrowser.itowns.DEMUtils.getElevationValueAt(
                          planarLayer,
                          new udvizBrowser.itowns.Coordinates(
                            configs['crs'][0].name,
                            c3DTFeaturePos
                          )
                        );
                    } else
                      featureElevation =
                        elevationLayer.colorTextureElevationMinZ;
                    c3DTFeature.groups.forEach((group) => {
                      const positionIndexStart = group.start * 3;
                      const positionIndexCount =
                        (group.start + group.count) * 3;
                      let min = Infinity;
                      let max = -Infinity;
                      for (
                        let index = positionIndexStart;
                        index < positionIndexCount;
                        index += 3
                      ) {
                        // z
                        el.geometry.attributes.position.array[index + 2] -=
                          worldBox3.min.z - featureElevation; // translation

                        min = Math.min(
                          el.geometry.attributes.position.array[index + 2],
                          min
                        );

                        max = Math.max(
                          el.geometry.attributes.position.array[index + 2],
                          max
                        );
                      }
                      tileContent.boundingVolume.box.min.z = min;
                      tileContent.boundingVolume.box.max.z = max;
                      el.geometry.attributes.position.needsUpdate = true;
                    });
                  }
                }
              });
            }
            frame3DPlanar.itownsView.notifyChange();
          };

          const changeVisualizationMode = () => {
            elevationLayer.scale = elevationLayer.scale == 1 ? 0 : 1;
            button.innerHTML =
              'Change visualization mode to ' +
              (elevationLayer.scale == 1 ? '2D' : '3D');
            frame3DPlanar.itownsView
              .getLayers()
              .filter((el) => el.isC3DTilesLayer)
              .forEach((layer) => {
                layer.object3d.traverse((child) => {
                  update3DTilesHeight(child);
                });
              });
          };

          button.onclick = changeVisualizationMode;

          frame3DPlanar.itownsView
            .getLayers()
            .filter((el) => el.isC3DTilesLayer)
            .forEach((layer) => {
              layer.addEventListener(
                udvizBrowser.itowns.C3DTILES_LAYER_EVENTS
                  .ON_TILE_CONTENT_LOADED,
                ({ tileContent }) => {
                  update3DTilesHeight(tileContent);
                }
              );
            });
        });
    </script>
    SCRIPT_TAG_RELOAD
  </body>
</html>
