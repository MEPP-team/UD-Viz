<!DOCTYPE html>
<html>
  <head>
    <title>2D Visualization example</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/css/examples.css" />
  </head>
  <body>
    <script src="../packages/browser/dist/RUN_MODE/bundle.js"></script>

    <script type="text/javascript">
      udvizBrowser.FileUtil.loadMultipleJSON([
        './assets/config/extent_lyon.json',
        './assets/config/frame3D_planars.json',
        './assets/config/layer/base_maps.json',
        './assets/config/layer/elevation.json',
        './assets/config/layer/3DTiles.json',
      ]).then((configs) => {
        // http://proj4js.org/
        // define a projection as a string and reference it that way
        // the definition of the projection should be in config TODO_ISSUE
        udvizBrowser.proj4.default.defs(
          configs['extent_lyon'].crs,
          '+proj=lcc +lat_1=45.25 +lat_2=46.75' +
            ' +lat_0=46 +lon_0=3 +x_0=1700000 +y_0=5200000 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs'
        );

        const extent = new udvizBrowser.itowns.Extent(
          configs['extent_lyon'].crs,
          parseInt(configs['extent_lyon'].west),
          parseInt(configs['extent_lyon'].east),
          parseInt(configs['extent_lyon'].south),
          parseInt(configs['extent_lyon'].north)
        );

        const frame3DPlanar = new udvizBrowser.Frame3DPlanar(
          extent,
          configs['frame3D_planars'][2]
        );

        // ADD BASE MAP
        udvizBrowser.addBaseMapLayer(
          configs['base_maps'][0],
          frame3DPlanar.itownsView,
          extent
        );

        // ADD ELEVATION LAYER
        udvizBrowser.addElevationLayer(
          configs['elevation'],
          frame3DPlanar.itownsView,
          extent
        );

        // ADD LAYERS
        udvizBrowser.add3DTilesLayers(
          configs['3DTiles'],
          frame3DPlanar.itownsView
        );

        const button = document.createElement('button');
        button.innerHTML = 'Change visualization mode to 3D';
        button.style.zIndex = 2;
        button.style.position = 'relative';
        button.style.cursor = 'pointer';
        frame3DPlanar.appendToUI(button);

        const planarLayer = frame3DPlanar.itownsView.tileLayer;
        const elevationLayer = frame3DPlanar.itownsView
          .getLayers()
          .filter((el) => el.isElevationLayer)[0];

        elevationLayer.scale = 0;

        const change3DTilesHeight = () => {
          frame3DPlanar.itownsView
            .getLayers()
            .filter((el) => el.isC3DTilesLayer)
            .forEach((layer) => {
              layer.object3d.traverse((child) => {
                if (
                  !isNaN(child.tileId) &&
                  child.tileId >= 0 &&
                  child.tileId < layer.tileset.tiles.length &&
                  layer.tilesC3DTileFeatures.has(child.tileId)
                ) {
                  for (const [
                    // eslint-disable-next-line no-unused-vars
                    batchId,
                    c3DTFeature,
                  ] of layer.tilesC3DTileFeatures.get(child.tileId)) {
                    child.traverse((child) => {
                      if (
                        child.geometry &&
                        child.geometry.attributes._BATCHID
                      ) {
                        const worldBox3 = layer.computeWorldBox3(c3DTFeature);
                        let featureElevation = worldBox3.min.z;

                        const c3DTFeaturePos = new udvizBrowser.THREE.Vector3()
                          .addVectors(worldBox3.max, worldBox3.min)
                          .divideScalar(2);
                        c3DTFeaturePos.z = worldBox3.min.z;
                        if (elevationLayer.scale == 1) {
                          featureElevation =
                            udvizBrowser.itowns.DEMUtils.getElevationValueAt(
                              planarLayer,
                              new udvizBrowser.itowns.Coordinates(
                                configs['extent_lyon'].crs,
                                c3DTFeaturePos
                              )
                            );
                        } else
                          featureElevation =
                            elevationLayer.colorTextureElevationMinZ;
                        c3DTFeature.groups.forEach((group) => {
                          const positionIndexStart = group.start * 3;
                          const positionIndexCount =
                            (group.start + group.count) * 3;

                          for (
                            let index = positionIndexStart;
                            index < positionIndexCount;
                            index += 3
                          ) {
                            // z
                            child.geometry.attributes.position.array[
                              index + 2
                            ] -= worldBox3.min.z - featureElevation; // translation
                          }
                          child.geometry.attributes.position.needsUpdate = true;
                        });
                      }
                    });
                  }
                  child.traverse((el) => {
                    if (el.geometry) {
                      el.geometry.computeBoundingBox();
                      child.boundingVolume.box = el.geometry.boundingBox;
                    }
                  });
                }
              });
            });
          frame3DPlanar.itownsView.notifyChange();
        };

        const changeVisualizationMode = () => {
          const elevationLayer = frame3DPlanar.itownsView
            .getLayers()
            .filter((el) => el.isElevationLayer)[0];

          elevationLayer.scale = elevationLayer.scale == 1 ? 0 : 1;
          button.innerHTML =
            'Change visualization mode to ' +
            (elevationLayer.scale == 1 ? '2D' : '3D');
          change3DTilesHeight();
        };

        button.onclick = changeVisualizationMode;

        frame3DPlanar.itownsView
          .getLayers()
          .filter((el) => el.isC3DTilesLayer)
          .forEach((layer) => {
            layer.addEventListener(
              udvizBrowser.itowns.C3DTILES_LAYER_EVENTS.ON_TILE_CONTENT_LOADED,
              change3DTilesHeight
            );
          });
      });
    </script>
    SCRIPT_TAG_RELOAD
  </body>
</html>
