<!DOCTYPE html>
<html>
  <head>
    <title>Document Widget example</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./assets/css/examples.css" />
  </head>
  <body>
    <script src="../packages/browser/dist/RUN_MODE/bundle.js"></script>

    <script type="text/javascript">
      udvizBrowser
        .loadMultipleJSON([
          './assets/config/extents.json',
          './assets/config/crs.json',
          './assets/config/frame3D_planars.json',
          './assets/config/server/spatial_multimedia_db_server.json',
          './assets/config/layer/3DTiles.json',
          './assets/config/layer/base_maps.json',
          './assets/config/layer/elevation.json'
        ])
        .then((configs) => {
          udvizBrowser.proj4.default.defs(
            configs['crs'][0].name,
            configs['crs'][0].transform
          );

          const extent = new udvizBrowser.itowns.Extent(
            configs['extents'][0].name,
            parseInt(configs['extents'][0].west),
            parseInt(configs['extents'][0].east),
            parseInt(configs['extents'][0].south),
            parseInt(configs['extents'][0].north)
          );

          const frame3DPlanar = new udvizBrowser.Frame3DPlanar(
            extent,
            configs['frame3D_planars'][2]
          );

          // /// ADD LAYERS
          udvizBrowser.add3DTilesLayers(
            configs['3DTiles'],
            frame3DPlanar.itownsView
          );

          udvizBrowser.addBaseMapLayer(
            configs['base_maps'][0],
            frame3DPlanar.itownsView,
            extent
          );

          udvizBrowser.addElevationLayer(
            configs['elevation'],
            frame3DPlanar.itownsView,
            extent
          );

          // quick fix but css needs to be remove from documents view TODO ISSUE
          const addToUI = (el) => {
            frame3DPlanar.domElementUI.appendChild(el);
            el.style.position = 'relative';
            el.style.zIndex = 2;
          };

          // REQUEST SERVICE
          const requestService = new udvizBrowser.RequestService();

          // AUTHENTICATION MODULE
          const authenticationView =
            new udvizBrowser.Widget.Server.AuthenticationView(
              new udvizBrowser.Widget.Server.AuthenticationService(
                requestService,
                configs['spatial_multimedia_db_server']
              )
            );

          const toggleAuthView = document.createElement('button');
          toggleAuthView.innerText = 'Show Authentification';
          addToUI(toggleAuthView);
          toggleAuthView.onclick = () => {
            if (!authenticationView.domElement.parentElement) {
              addToUI(authenticationView.domElement);
              authenticationView.domElement.style.position = 'absolute';
            }
          };

          // DOCUMENTS MODULE
          const documentCore = new udvizBrowser.Widget.Server.Document.Core(
            requestService,
            configs['spatial_multimedia_db_server']
          );

          const parentNavigator = document.createElement('div');
          parentNavigator.style.width = '200px';
          parentNavigator.style.backgroundColor = 'white';
          parentNavigator.appendChild(
            documentCore.view.navigatorWindow.domElement
          );

          addToUI(parentNavigator);

          const parentInspector = document.createElement('div');
          parentInspector.style.width = 'fit-content';
          parentInspector.style.position = 'absolute';
          parentInspector.style.right = '0px';
          parentInspector.style.top = '0px';
          parentInspector.style.backgroundColor = 'white';
          parentInspector.appendChild(
            documentCore.view.inspectorWindow.domElement
          );

          addToUI(parentInspector);

          // DOCUMENTS VISUALIZER EXTENSION (to orient the document)
          const visualizerView =
            new udvizBrowser.Widget.Server.Document.VisualizerView(
              frame3DPlanar.itownsView,
              documentCore.provider
            );

          const visualizeButton = document.createElement('button');
          visualizeButton.innerText = 'Visualize';
          visualizerView.domElement.style.zIndex = 5;
          visualizeButton.onclick = async () => {
            await visualizerView.startTravelToDisplayedDocument();
            addToUI(visualizerView.domElement);
          };
          documentCore.view.inspectorWindow.domElement.appendChild(
            visualizeButton
          );

          const parentBottomRight = document.createElement('div');
          parentBottomRight.style.position = 'absolute';
          parentBottomRight.style.backgroundColor = 'white';
          parentBottomRight.style.bottom = '0px';
          parentBottomRight.style.right = '0px';
          addToUI(parentBottomRight);

          // DOCUMENT CONTRIBUTE

          const documentContribute =
            new udvizBrowser.Widget.Server.Document.Contribute(
              documentCore.provider,
              visualizerView,
              requestService,
              frame3DPlanar.itownsView,
              frame3DPlanar.itownsView.controls,
              configs['spatial_multimedia_db_server'],
              frame3DPlanar.domElementUI
            );

          const updateButton = document.createElement('button');
          updateButton.innerText = 'Update';
          updateButton.onclick = async () => {
            await documentContribute.updateWindow.updateFromDisplayedDocument();
            udvizBrowser.clearChildren(parentBottomRight);
            parentBottomRight.appendChild(
              documentContribute.updateWindow.domElement
            );
          };
          documentCore.view.inspectorWindow.domElement.appendChild(
            updateButton
          );

          const deleteButton = document.createElement('button');
          deleteButton.innerText = 'Delete';
          deleteButton.onclick = async () => {
            if (
              !confirm(
                'You are going to delete the document. This operation ' +
                  'is irreversible. Do you want to continue ?'
              )
            ) {
              return;
            }
            try {
              await documentContribute.contributeService.deleteDocument();
            } catch (e) {
              alert(e);
            }
          };
          documentCore.view.inspectorWindow.domElement.appendChild(
            deleteButton
          );

          const createDocumentButton = document.createElement('button');
          createDocumentButton.innerText = 'Create new document';
          createDocumentButton.onclick = () => {
            udvizBrowser.clearChildren(parentBottomRight);
            parentBottomRight.appendChild(
              documentContribute.creationWindow.domElement
            );
          };
          documentCore.view.navigatorWindow.documentListContainer.appendChild(
            createDocumentButton
          );

          // DOCUMENT VALIDATION
          const documentValidation =
            new udvizBrowser.Widget.Server.Document.Validation(
              documentCore.provider,
              requestService,
              configs['spatial_multimedia_db_server'],
              documentCore.view.inspectorWindow.domElement
            );

          documentCore.view.navigatorWindow.displayableFiltersContainer.appendChild(
            documentValidation.validationView.domElement
          );

          // DOCUMENT COMMENTS
          const documentComment =
            new udvizBrowser.Widget.Server.Document.Comment(
              documentCore.provider,
              requestService,
              configs['spatial_multimedia_db_server']
            );

          const commentButton = document.createElement('button');
          commentButton.innerText = 'Comment';
          commentButton.onclick = async () => {
            udvizBrowser.clearChildren(parentBottomRight);
            await documentComment.commentsWindow.getComments();
            parentBottomRight.appendChild(
              documentComment.commentsWindow.domElement
            );
          };

          documentCore.view.inspectorWindow.domElement.appendChild(
            commentButton
          );
        });
    </script>
    SCRIPT_TAG_RELOAD
  </body>
</html>
